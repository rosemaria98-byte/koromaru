<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ころまるジャンプ</title>
<style>
body{
  margin:0;
  background:#ffeef5;
  overflow:hidden;
  font-family:sans-serif;
  touch-action:none;
}
canvas{
  display:block;
  margin:auto;
  background:#fff;
}
#hp{
  position:absolute;
  left:10px;
  top:10px;
  font-size:20px;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="hp">HP: 5</div>
<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let hp = 5;

// ===== ころまる画像 =====
const koro = {
 idle:new Image(),
 jump:new Image(),
 happy:new Image(),
 hit:new Image(),
 dead:new Image()
};
koro.idle.src="koromaru_idle.png";
koro.jump.src="koromaru_jump.png";
koro.happy.src="koromaru_happy.png";
koro.hit.src="koromaru_hit.png";
koro.dead.src="koromaru_dead.png";

let current=koro.idle;
let emotionTimer=0;

// ===== プレイヤー =====
let player={
 x:140,
 y:450,
 vy:0,
 onGround:true,
 size:120
};

// ===== アイテム =====
let items=[];

function spawnItem(){
 let type=Math.random()<0.7?"snack":"bomb";
 items.push({
  x: Math.random()*350,
  y:-50,
  type:type
 });
}
setInterval(spawnItem,900);

// ===== 操作（スマホ対応 横移動）=====
let touching=false;

canvas.addEventListener("touchstart",e=>{
 touching=true;
 movePlayer(e);
 jump();
});

canvas.addEventListener("touchmove",e=>{
 if(touching) movePlayer(e);
});

canvas.addEventListener("touchend",()=>{
 touching=false;
});

function movePlayer(e){
 const rect = canvas.getBoundingClientRect();
 const touchX = e.touches[0].clientX - rect.left;

 player.x = touchX - player.size/2;

 if(player.x<0) player.x=0;
 if(player.x>canvas.width-player.size)
   player.x=canvas.width-player.size;
}

// PC操作
document.addEventListener("keydown",e=>{
 if(e.code==="Space") jump();
 if(e.code==="ArrowLeft") player.x-=25;
 if(e.code==="ArrowRight") player.x+=25;
});

// ジャンプ
function jump(){
 if(player.onGround){
  player.vy=-15;
  player.onGround=false;
 }
}

// ===== 更新 =====
function update(){

 player.vy+=0.8;
 player.y+=player.vy;

 if(player.y>450){
  player.y=450;
  player.vy=0;
  player.onGround=true;
 }

 if(emotionTimer>0){
  emotionTimer--;
 }else{
  if(player.onGround) current=koro.idle;
  else current=koro.jump;
 }

 items.forEach(i=>{
  i.y+=5;

  if(
   i.x<player.x+80 &&
   i.x+40>player.x &&
   i.y<player.y+80 &&
   i.y+40>player.y
  ){
   if(i.type=="snack"){
    current=koro.happy;
    emotionTimer=20;
   }else{
    hp--;
    document.getElementById("hp").textContent="HP: "+hp;
    current=koro.hit;
    emotionTimer=25;

    if(hp<=0){
     current=koro.dead;
    }
   }
   i.y=700;
  }
 });

 items=items.filter(i=>i.y<650);
}

// ===== 描画 =====
function draw(){
 ctx.clearRect(0,0,400,600);

 ctx.drawImage(current,player.x,player.y,player.size,player.size);

 items.forEach(i=>{
  ctx.fillStyle=i.type=="snack"?"#ffcc66":"#333";
  ctx.beginPath();
  ctx.arc(i.x+20,i.y+20,20,0,Math.PI*2);
  ctx.fill();
 });
}

// ===== ループ =====
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
