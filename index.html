<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ころまるジャンプ</title>
<style>
body{
  margin:0;
  background:#ffeef5;
  overflow:hidden;
  font-family:sans-serif;
  touch-action:none;
}
canvas{
  display:block;
  margin:0 auto;
  background:#fff;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== 画面サイズ自動調整 =====
function resize(){
 canvas.width = window.innerWidth;
 canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

let hp = 5;

// ===== ころまる画像 =====
const koro = {
 idle:new Image(),
 jump:new Image(),
 happy:new Image(),
 hit:new Image(),
 dead:new Image()
};
koro.idle.src="koromaru_idle.png";
koro.jump.src="koromaru_jump.png";
koro.happy.src="koromaru_happy.png";
koro.hit.src="koromaru_hit.png";
koro.dead.src="koromaru_dead.png";

let current=koro.idle;
let emotionTimer=0;

// ===== プレイヤー =====
let player={
 x:150,
 y:0,
 vy:0,
 onGround:true,
 size:140
};

function groundY(){
 return canvas.height-160;
}

// ===== アイテム =====
let items=[];

function spawnItem(){
 let type=Math.random()<0.7?"snack":"bomb";
 items.push({
  x: Math.random()*(canvas.width-40),
  y:-50,
  type:type
 });
}
setInterval(spawnItem,900);

// ===== 操作 =====
let touching=false;

canvas.addEventListener("touchstart",e=>{
 touching=true;
 movePlayer(e);
 jump();
});
canvas.addEventListener("touchmove",e=>{
 if(touching) movePlayer(e);
});
canvas.addEventListener("touchend",()=>touching=false);

function movePlayer(e){
 const rect = canvas.getBoundingClientRect();
 const touchX = e.touches[0].clientX - rect.left;
 player.x = touchX - player.size/2;

 if(player.x<0) player.x=0;
 if(player.x>canvas.width-player.size)
   player.x=canvas.width-player.size;
}

function jump(){
 if(player.onGround){
  player.vy=-18;
  player.onGround=false;
 }
}

// ===== 更新 =====
function update(){

 player.vy+=0.9;
 player.y+=player.vy;

 if(player.y>groundY()){
  player.y=groundY();
  player.vy=0;
  player.onGround=true;
 }

 if(emotionTimer>0){
  emotionTimer--;
 }else{
  current=player.onGround?koro.idle:koro.jump;
 }

 items.forEach(i=>{
  i.y+=6;

  if(
   i.x<player.x+100 &&
   i.x+40>player.x &&
   i.y<player.y+100 &&
   i.y+40>player.y
  ){
   if(i.type=="snack"){
    current=koro.happy;
    emotionTimer=20;
   }else{
    hp--;
    current=koro.hit;
    emotionTimer=25;
    if(hp<=0) current=koro.dead;
   }
   i.y=canvas.height+100;
  }
 });

 items=items.filter(i=>i.y<canvas.height+50);
}

// ===== 描画 =====
function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);

 // 地面
 ctx.fillStyle="#ffddee";
 ctx.fillRect(0,groundY()+player.size-20,canvas.width,40);

 // ころまる
 ctx.drawImage(current,player.x,player.y,player.size,player.size);

 // アイテム
 items.forEach(i=>{
  ctx.fillStyle=i.type=="snack"?"#ffcc66":"#333";
  ctx.beginPath();
  ctx.arc(i.x+20,i.y+20,20,0,Math.PI*2);
  ctx.fill();
 });

 // ★HPを画面内に描画
 ctx.fillStyle="#ff4d6d";
 ctx.font="bold 28px sans-serif";
 ctx.fillText("HP: "+hp,20,40);
}

// ===== ループ =====
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
