<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ころまるジャンプ</title>
<style>
body{
  margin:0;
  background:#ffeef5;
  overflow:hidden;
  font-family:sans-serif;
  touch-action:none;
}
canvas{
  display:block;
  margin:0 auto;
  background:#fff;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== 画面サイズ =====
function resize(){
 canvas.width = window.innerWidth;
 canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

// ===== 状態 =====
let scene="title"; // title, game, gameover

let hp=5;

// ===== 画像 =====
const titleImg=new Image();
titleImg.src="title.png";

const koro={
 idle:new Image(),
 jump:new Image(),
 happy:new Image(),
 hit:new Image(),
 dead:new Image()
};
koro.idle.src="koromaru_idle.png";
koro.jump.src="koromaru_jump.png";
koro.happy.src="koromaru_happy.png";
koro.hit.src="koromaru_hit.png";
koro.dead.src="koromaru_dead.png";

let current=koro.idle;
let emotionTimer=0;

// ===== プレイヤー =====
let player={
 x:50,
 y:0,
 vy:0,
 onGround:true,
 size:540
};

function groundY(){
 return canvas.height-player.size-10;
}

// ===== アイテム =====
let items=[];

function spawnItem(){
 if(scene!=="game") return;
 let type=Math.random()<0.7?"snack":"bomb";
 items.push({
  x: Math.random()*(canvas.width-80),
  y:-80,
  type:type,
  r:35
 });
}
setInterval(spawnItem,1000);

// ===== 操作 =====
canvas.addEventListener("touchstart",e=>{
 if(scene==="title"){
  startGame();
  return;
 }
 if(scene==="gameover"){
  scene="title";
  return;
 }
 movePlayer(e);
 jump();
});

canvas.addEventListener("touchmove",movePlayer);

function startGame(){
 hp=5;
 items=[];
 player.y=groundY();
 player.vy=0;
 scene="game";
}

function movePlayer(e){
 if(scene!=="game") return;
 const rect=canvas.getBoundingClientRect();
 const touchX=e.touches[0].clientX-rect.left;
 player.x=touchX-player.size/2;
 if(player.x<0)player.x=0;
 if(player.x>canvas.width-player.size)
   player.x=canvas.width-player.size;
}

function jump(){
 if(player.onGround){
  player.vy=-28;
  player.onGround=false;
 }
}

// ===== 更新 =====
function update(){
 if(scene!=="game") return;

 player.vy+=1.2;
 player.y+=player.vy;

 if(player.y>groundY()){
  player.y=groundY();
  player.vy=0;
  player.onGround=true;
 }

 if(emotionTimer>0) emotionTimer--;
 else current=player.onGround?koro.idle:koro.jump;

 items.forEach(i=>{
  i.y+=8;

  if(
   i.x<player.x+player.size*0.75 &&
   i.x+i.r*2>player.x+player.size*0.25 &&
   i.y<player.y+player.size*0.75 &&
   i.y+i.r*2>player.y+player.size*0.25
  ){
   if(i.type==="snack"){
    current=koro.happy;
    emotionTimer=20;
   }else{
    hp--;
    current=koro.hit;
    emotionTimer=30;
    if(hp<=0) scene="gameover";
   }
   i.y=canvas.height+200;
  }
 });
}

// ===== 描画 =====
function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);

 if(scene==="title"){
  ctx.drawImage(titleImg,0,0,canvas.width,canvas.height);
  ctx.fillStyle="#fff";
  ctx.font="bold 40px sans-serif";
  ctx.fillText("タップしてスタート",canvas.width/2-160,canvas.height*0.8);
  return;
 }

 if(scene==="gameover"){
  ctx.fillStyle="#000";
  ctx.font="bold 60px sans-serif";
  ctx.fillText("GAME OVER",canvas.width/2-180,canvas.height/2);
  ctx.font="30px sans-serif";
  ctx.fillText("タップでタイトルへ",canvas.width/2-150,canvas.height/2+60);
  return;
 }

 // 地面
 ctx.fillStyle="#ffddee";
 ctx.fillRect(0,groundY()+player.size-20,canvas.width,50);

 // ころまる
 ctx.drawImage(current,player.x,player.y,player.size,player.size);

 // アイテム
 items.forEach(i=>{
  ctx.fillStyle=i.type=="snack"?"#ffcc66":"#222";
  ctx.beginPath();
  ctx.arc(i.x+i.r,i.y+i.r,i.r,0,Math.PI*2);
  ctx.fill();
 });

 // HP
 ctx.fillStyle="#ff3366";
 ctx.font="bold 36px sans-serif";
 ctx.fillText("HP: "+hp,30,60);
}

// ===== ループ =====
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
